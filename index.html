<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly Subscription Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    .container { max-width: 850px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    input, select, button { padding: 10px; margin: 5px 0; width: 100%; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #2563eb; color: #fff; border: none; cursor: pointer; font-size: 1rem; }
    button:hover { background: #1d4ed8; }
    #search { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 6px; }
    .exp-list { list-style: none; padding: 0; margin: 0; }
    .exp-item { background: #e6ffe6; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); padding: 0; transition: background 0.2s; }
    .exp-item.expired { background: #ffe5e5; }
    .exp-header { cursor: pointer; padding: 15px; font-weight: bold; font-size: 1.1rem; color: #2563eb; display: flex; align-items: center; justify-content: space-between; }
    .exp-header .status { font-size: 0.95rem; font-weight: normal; padding: 2px 8px; border-radius: 8px; }
    .exp-header .status.active { background: #e6ffe6; color: #2e7d32; }
    .exp-header .status.expired { background: #ffe5e5; color: #d32f2f; }
    .exp-content { display: none; padding: 12px 18px 16px 18px; border-top: 1px solid #ddd; font-size: 0.97rem; background: #fff; border-radius: 0 0 8px 8px; animation: fadeIn 0.2s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .btn-small { padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; cursor: pointer; margin: 2px; }
    .btn-delete { background: #e53935; color: #fff; border: none; }
    .btn-delete:hover { background: #c62828; }
    .btn-renew { background: #43a047; color: #fff; border: none; }
    .btn-renew:hover { background: #2e7d32; }
    .deleted-section { margin-top: 40px; background: #fff7e6; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.07); }
    .deleted-title { color: #d32f2f; font-weight: bold; margin-bottom: 10px; }
    .deleted-list .exp-header { color: #d32f2f; }
    .deleted-list .exp-item { background: #fff7e6; }
    /* Modal styles */
    #editModal {
      display: none; position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.35); z-index:1000; align-items:center; justify-content:center;
    }
    #editModal .modal-content {
      background:#fff; border-radius:10px; max-width:350px; margin:auto; padding:24px 18px;
      box-shadow:0 4px 12px rgba(0,0,0,0.13); position:relative;
    }
    #editModal input, #editModal select, #editModal button {
      width: 100%;
      margin-bottom: 8px;
    }
    #editModal h2 { margin-top: 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Weekly Subscription Tracker</h1>

    <input type="text" id="name" placeholder="Name">
    <input type="tel" id="phone" placeholder="Phone Number">
    <input type="number" id="amount" placeholder="Amount Paid">
    <select id="clientType">
      <option value="Client">Client</option>
      <option value="Not Mine">Not Mine</option>
    </select>
    <input type="date" id="startDate" placeholder="Select start date">
    <button onclick="addSubscription()">Add Subscription</button>

    <input type="text" id="search" placeholder="Search by phone number..." onkeyup="searchSubscriptions()">

    <!-- Add the button for re-editing missing name by phone number -->
    <button onclick="findAndEditMissingName()" style="margin-bottom:12px;width:100%;background:#ff9800;color:#fff;">Re-edit Missing Name by Phone</button>

    <ul id="subList" class="exp-list"></ul>
    <div class="deleted-section" id="deletedSection" style="display:none;">
      <div class="deleted-title">Deleted Names (Can be renewed if paid):</div>
      <ul id="deletedList" class="exp-list deleted-list"></ul>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal">
    <div class="modal-content">
      <h2>Edit & Renew Subscription</h2>
      <input type="text" id="editName" placeholder="Name">
      <input type="tel" id="editPhone" placeholder="Phone Number">
      <input type="number" id="editAmount" placeholder="Amount Paid">
      <select id="editClientType">
        <option value="Client">Client</option>
        <option value="Not Mine">Not Mine</option>
      </select>
      <button onclick="confirmEditRenew()" style="width:100%;margin-top:12px;">Save & Renew</button>
      <button onclick="closeEditModal()" style="width:100%;margin-top:8px;background:#eee;color:#333;">Cancel</button>
    </div>
  </div>

  <script>
    let subscriptions = JSON.parse(localStorage.getItem("subscriptions")) || [];
    let deletedSubscriptions = JSON.parse(localStorage.getItem("deletedSubscriptions")) || [];

    let editIndex = null;
    let editIsDeleted = false;

    function saveSubscriptions() {
      localStorage.setItem("subscriptions", JSON.stringify(subscriptions));
      localStorage.setItem("deletedSubscriptions", JSON.stringify(deletedSubscriptions));
    }

    function addSubscription() {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const amount = document.getElementById("amount").value.trim();
      const clientType = document.getElementById("clientType").value;
      const startDateInput = document.getElementById("startDate").value;

      if (!phone || !amount || !startDateInput) {
        alert("Please fill in all fields except name (name can be edited later)");
        return;
      }

      // Dates
      const start = new Date(startDateInput);
      const expiry = new Date(start);
      expiry.setDate(start.getDate() + 7);

      const sub = {
        name,
        phone,
        amount: parseFloat(amount),
        clientType,
        start: start.toLocaleDateString(),
        end: expiry.toLocaleDateString(),
        startISO: start.toISOString(),
        endISO: expiry.toISOString()
      };

      subscriptions.push(sub);
      saveSubscriptions();
      renderList();

      document.getElementById("name").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("amount").value = "";
      document.getElementById("startDate").value = "";
    }

    function deleteSubscription(index) {
      const sub = subscriptions[index];
      deletedSubscriptions.push({
        name: sub.name,
        phone: sub.phone,
        clientType: sub.clientType,
        deletedOn: new Date().toLocaleDateString()
      });
      subscriptions.splice(index, 1);
      saveSubscriptions();
      renderList();
      renderDeletedList();
    }

    // Modal logic for edit & renew
    function openEditModal(index, isDeleted) {
      editIndex = index;
      editIsDeleted = isDeleted;
      let s = isDeleted ? deletedSubscriptions[index] : subscriptions[index];
      document.getElementById("editName").value = s.name || "";
      document.getElementById("editPhone").value = s.phone || "";
      document.getElementById("editAmount").value = isDeleted ? "" : (s.amount !== undefined ? s.amount : "");
      document.getElementById("editClientType").value = s.clientType || "Client";
      document.getElementById("editModal").style.display = "flex";
    }

    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
      editIndex = null;
      editIsDeleted = false;
    }

    function confirmEditRenew() {
      const name = document.getElementById("editName").value.trim();
      const phone = document.getElementById("editPhone").value.trim();
      const amount = document.getElementById("editAmount").value.trim();
      const clientType = document.getElementById("editClientType").value;
      const today = new Date();
      const expiry = new Date(today);
      expiry.setDate(today.getDate() + 7);

      if (!name || !phone || (!editIsDeleted && !amount)) {
        alert("Please fill in all fields");
        return;
      }

      if (editIsDeleted) {
        // Renew and edit deleted subscription
        deletedSubscriptions.splice(editIndex, 1);
        subscriptions.push({
          name,
          phone,
          amount: amount ? parseFloat(amount) : 0,
          clientType,
          start: today.toLocaleDateString(),
          end: expiry.toLocaleDateString(),
          startISO: today.toISOString(),
          endISO: expiry.toISOString()
        });
        saveSubscriptions();
        renderList();
        renderDeletedList();
      } else {
        // Edit and renew active subscription
        subscriptions[editIndex].name = name;
        subscriptions[editIndex].phone = phone;
        subscriptions[editIndex].amount = parseFloat(amount);
        subscriptions[editIndex].clientType = clientType;
        subscriptions[editIndex].start = today.toLocaleDateString();
        subscriptions[editIndex].end = expiry.toLocaleDateString();
        subscriptions[editIndex].startISO = today.toISOString();
        subscriptions[editIndex].endISO = expiry.toISOString();
        saveSubscriptions();
        renderList();
      }
      closeEditModal();
    }

    // Function to re-edit subscriptions with missing names by phone number
    function findAndEditMissingName() {
      const phone = prompt("Enter client's phone number:");
      if (!phone) return;

      const index = subscriptions.findIndex(s => s.phone === phone && (!s.name || s.name.trim() === ""));
      if (index === -1) {
        alert("No subscription found with that phone number and missing name.");
        return;
      }

      // Open edit modal for missing name
      openEditModal(index, false);
    }

    // Auto-remove expired subscriptions before rendering
    function autoRemoveExpired() {
      const today = new Date();
      let changed = false;
      subscriptions = subscriptions.filter((sub, index) => {
        const endDate = new Date(sub.endISO || sub.end);
        if (today > endDate) {
          // Move to deleted list
          deletedSubscriptions.push({
            name: sub.name,
            phone: sub.phone,
            clientType: sub.clientType,
            deletedOn: today.toLocaleDateString()
          });
          changed = true;
          return false;
        }
        return true;
      });
      if (changed) saveSubscriptions();
    }

    function renderList(filteredList = null) {
      autoRemoveExpired(); // Remove expired before rendering

      const ul = document.getElementById("subList");
      ul.innerHTML = "";

      const today = new Date();
      const list = filteredList || subscriptions;

      list.forEach((s, index) => {
        const endDate = new Date(s.endISO || s.end);
        let statusClass = "";
        let statusText = "";

        if (today > endDate) {
          statusClass = "expired";
          statusText = "Expired";
        } else {
          statusClass = "active";
          statusText = "Active";
        }

        const li = document.createElement("li");
        li.className = `exp-item ${statusClass}`;

        // Header
        const header = document.createElement("div");
        header.className = "exp-header";
        header.innerHTML = `
          <span>${s.name ? s.name : "<em style='color:red;'>Name Missing</em>"}</span>
          <span class="status ${statusClass}">${statusText}</span>
        `;
        header.onclick = function() {
          content.style.display = content.style.display === "block" ? "none" : "block";
        };

        // Content
        const content = document.createElement("div");
        content.className = "exp-content";
        content.innerHTML = `
          <div><strong>Phone:</strong> ${s.phone}</div>
          <div><strong>Amount:</strong> ${s.amount !== undefined ? s.amount : ""}</div>
          <div><strong>Client Type:</strong> ${s.clientType}</div>
          <div><strong>Start Date:</strong> ${s.start}</div>
          <div><strong>End Date:</strong> ${s.end}</div>
          <div style="margin-top:12px;">
            <button class="btn-small btn-renew" onclick="openEditModal(${subscriptions.indexOf(s)}, false)">Renew & Edit</button>
            <button class="btn-small btn-delete" onclick="deleteSubscription(${subscriptions.indexOf(s)})">Delete</button>
            ${(!s.name || s.name.trim() === "") ? `<button class="btn-small" style="background:#ff9800;color:#fff;" onclick="openEditModal(${subscriptions.indexOf(s)}, false)">Re-edit Name</button>` : ""}
          </div>
        `;

        li.appendChild(header);
        li.appendChild(content);
        ul.appendChild(li);
      });
    }

    function renderDeletedList() {
      const section = document.getElementById("deletedSection");
      const ul = document.getElementById("deletedList");
      ul.innerHTML = "";

      if (deletedSubscriptions.length === 0) {
        section.style.display = "none";
        return;
      }
      section.style.display = "block";

      deletedSubscriptions.forEach((d, index) => {
        const li = document.createElement("li");
        li.className = "exp-item";

        // Header
        const header = document.createElement("div");
        header.className = "exp-header";
        header.innerHTML = `
          <span>${d.name ? d.name : "<em style='color:red;'>Name Missing</em>"}</span>
          <span class="status expired">Deleted</span>
        `;
        header.onclick = function() {
          content.style.display = content.style.display === "block" ? "none" : "block";
        };

        // Content
        const content = document.createElement("div");
        content.className = "exp-content";
        content.innerHTML = `
          <div><strong>Phone:</strong> ${d.phone}</div>
          <div><strong>Client Type:</strong> ${d.clientType}</div>
          <div><strong>Deleted On:</strong> ${d.deletedOn}</div>
          <div style="margin-top:12px;">
            <button class="btn-small btn-renew" onclick="openEditModal(${index}, true)">Renew & Edit</button>
            ${(!d.name || d.name.trim() === "") ? `<button class="btn-small" style="background:#ff9800;color:#fff;" onclick="openEditModal(${index}, true)">Re-edit Name</button>` : ""}
          </div>
        `;

        li.appendChild(header);
        li.appendChild(content);
        ul.appendChild(li);
      });
    }

    function searchSubscriptions() {
      const query = document.getElementById("search").value.trim();
      if (!query) {
        renderList();
        return;
      }
      const filtered = subscriptions.filter(s => s.phone.includes(query));
      renderList(filtered);
    }

    // Initial render
    renderList();
    renderDeletedList();
  </script>
</body>
  </html>
