<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly Subscription Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #2563eb; }
    .container { max-width: 850px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    input, select, button { padding: 10px; margin: 5px 0; width: 100%; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }
    button { background: #2563eb; color: #fff; border: none; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
    button:hover { background: #1d4ed8; }
    #search { margin: 15px 0; }
    .exp-list { list-style: none; padding: 0; margin: 0; }
    .exp-item { background: #e6ffe6; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); overflow: hidden; transition: background 0.2s; }
    .exp-item.expired { background: #ffe5e5; }
    .exp-header { cursor: pointer; padding: 15px; font-weight: bold; font-size: 1.05rem; color: #2563eb; display: flex; align-items: center; justify-content: space-between; }
    .exp-header .status { font-size: 0.9rem; padding: 2px 8px; border-radius: 8px; }
    .status.active { background: #c8facc; color: #2e7d32; }
    .status.expired { background: #ffd4d4; color: #d32f2f; }
    .exp-content { display: none; padding: 12px 18px 16px; border-top: 1px solid #ddd; font-size: 0.95rem; background: #fff; animation: fadeIn 0.2s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .btn-small { padding: 5px 10px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; margin: 2px; }
    .btn-delete { background: #e53935; color: #fff; border: none; }
    .btn-delete:hover { background: #c62828; }
    .btn-renew { background: #43a047; color: #fff; border: none; }
    .btn-renew:hover { background: #2e7d32; }
    .btn-edit-missing { background: #ff9800; color: #fff; border: none; }
    .btn-edit-missing:hover { background: #e68900; }
    /* Modal styles */
    #editModal {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.35); z-index: 1000; align-items: center; justify-content: center;
    }
    #editModal .modal-content {
      background: #fff; border-radius: 10px; max-width: 350px; margin: auto; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.13);
    }
    #editModal h2 { margin-top: 0; color: #2563eb; }
    #editModal input, #editModal select, #editModal button { margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Weekly Subscription Tracker</h1>

    <input type="text" id="name" placeholder="Name (optional)">
    <input type="tel" id="phone" placeholder="Phone Number">
    <input type="number" id="amount" placeholder="Amount Paid">
    <select id="clientType">
      <option value="Client">Client</option>
      <option value="Not Mine">Not Mine</option>
    </select>
    <input type="date" id="startDate">
    <button onclick="addSubscription()">Add Subscription</button>

    <input type="text" id="search" placeholder="Search by phone number..." onkeyup="searchSubscriptions()">

    <button onclick="findAndEditMissingName()" class="btn-edit-missing" style="width:100%;margin-bottom:12px;">
      Re-edit Missing Name by Phone
    </button>

    <ul id="subList" class="exp-list"></ul>
  </div>

  <!-- Edit Modal -->
  <div id="editModal">
    <div class="modal-content">
      <h2>Edit & Renew</h2>
      <input type="text" id="editName" placeholder="Name">
      <input type="tel" id="editPhone" placeholder="Phone Number">
      <input type="number" id="editAmount" placeholder="Amount Paid">
      <select id="editClientType">
        <option value="Client">Client</option>
        <option value="Not Mine">Not Mine</option>
      </select>
      <button onclick="confirmEditRenew()">Save & Renew</button>
      <button onclick="closeEditModal()" style="background:#eee;color:#333;">Cancel</button>
    </div>
  </div>

  <script>
    let subscriptions = JSON.parse(localStorage.getItem("subscriptions")) || [];
    let editIndex = null;

    function saveSubscriptions() {
      localStorage.setItem("subscriptions", JSON.stringify(subscriptions));
    }

    function addSubscription() {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const amount = document.getElementById("amount").value.trim();
      const clientType = document.getElementById("clientType").value;
      const startDate = document.getElementById("startDate").value;

      if (!phone || !amount || !startDate) {
        alert("Phone, amount, and start date are required. Name is optional.");
        return;
      }

      const start = new Date(startDate);
      const end = new Date(start); end.setDate(start.getDate() + 7);

      subscriptions.push({
        name, phone, amount: parseFloat(amount), clientType,
        start: start.toLocaleDateString(), end: end.toLocaleDateString(),
        startISO: start.toISOString(), endISO: end.toISOString()
      });

      saveSubscriptions();
      renderList();

      document.getElementById("name").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("amount").value = "";
      document.getElementById("startDate").value = "";
    }

    function deleteSubscription(index) {
      if (!confirm("Are you sure you want to permanently delete this subscription?")) return;
      subscriptions.splice(index, 1);
      saveSubscriptions();
      renderList();
    }

    function openEditModal(index) {
      editIndex = index;
      const s = subscriptions[index];
      document.getElementById("editName").value = s.name || "";
      document.getElementById("editPhone").value = s.phone || "";
      document.getElementById("editAmount").value = s.amount || "";
      document.getElementById("editClientType").value = s.clientType || "Client";
      document.getElementById("editModal").style.display = "flex";
    }

    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
      editIndex = null;
    }

    function confirmEditRenew() {
      const name = document.getElementById("editName").value.trim();
      const phone = document.getElementById("editPhone").value.trim();
      const amount = document.getElementById("editAmount").value.trim();
      const clientType = document.getElementById("editClientType").value;

      if (!phone || !amount) { alert("Phone and amount are required."); return; }

      const today = new Date();
      const end = new Date(today); end.setDate(today.getDate() + 7);

      Object.assign(subscriptions[editIndex], {
        name, phone, amount: parseFloat(amount), clientType,
        start: today.toLocaleDateString(), end: end.toLocaleDateString(),
        startISO: today.toISOString(), endISO: end.toISOString()
      });

      saveSubscriptions();
      renderList();
      closeEditModal();
    }

    function findAndEditMissingName() {
      const phone = prompt("Enter client's phone number:");
      if (!phone) return;
      const index = subscriptions.findIndex(s => s.phone === phone && !s.name);
      if (index === -1) { alert("No record found with missing name."); return; }
      openEditModal(index);
    }

    function autoRemoveExpired() {
      const today = new Date();
      let changed = false;
      subscriptions = subscriptions.filter(sub => {
        const end = new Date(sub.endISO || sub.end);
        if (today > end) { changed = true; return false; }
        return true;
      });
      if (changed) saveSubscriptions();
    }

    function renderList(list = subscriptions) {
      autoRemoveExpired();
      const ul = document.getElementById("subList"); ul.innerHTML = "";
      const today = new Date();

      list.forEach((s, i) => {
        const end = new Date(s.endISO || s.end);
        const status = today > end ? "expired" : "active";
        const statusText = status === "expired" ? "Expired" : "Active";

        const li = document.createElement("li");
        li.className = `exp-item ${status}`;

        const header = document.createElement("div");
        header.className = "exp-header";
        header.innerHTML = `
          <span>${s.name || "<em style='color:red;'>Name Missing</em>"} 
            <span style="color:#2563eb;font-size:0.9em;margin-left:8px;">${s.phone}</span>
          </span>
          <span class="status ${status}">${statusText}</span>
        `;
        const content = document.createElement("div");
        content.className = "exp-content";
        content.innerHTML = `
          <div><strong>Phone:</strong> ${s.phone}</div>
          <div><strong>Amount:</strong> ${s.amount}</div>
          <div><strong>Client Type:</strong> ${s.clientType}</div>
          <div><strong>Start:</strong> ${s.start}</div>
          <div><strong>End:</strong> ${s.end}</div>
          <div style="margin-top:10px;">
            <button class="btn-small btn-renew" onclick="openEditModal(${i})">Renew & Edit</button>
            <button class="btn-small btn-delete" onclick="deleteSubscription(${i})">Delete</button>
            ${!s.name ? `<button class="btn-small btn-edit-missing" onclick="openEditModal(${i})">Re-edit Name</button>` : ""}
          </div>
        `;
        header.onclick = () => content.style.display = content.style.display === "block" ? "none" : "block";

        li.appendChild(header);
        li.appendChild(content);
        ul.appendChild(li);
      });
    }

    function searchSubscriptions() {
      const q = document.getElementById("search").value.trim();
      renderList(q ? subscriptions.filter(s => s.phone.includes(q)) : subscriptions);
    }

    renderList();
  </script>
</body>
</html>
